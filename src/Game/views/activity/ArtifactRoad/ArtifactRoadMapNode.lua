---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by pengjixian.
--- DateTime: 2018/11/21 4:05 PM
---
--[[
活动副本地图关卡node
--]]
local VIEW_SIZE = cc.size(161, 148)
local ArtifactRoadMapNode = class('ArtifactRoadMapNode', function ()
    local node = CColorView:create()
    node:setAnchorPoint(cc.p(0.5, 0))
    node:setContentSize(VIEW_SIZE)
    node.name = 'Game.views.activity.ArtifactRoad.ArtifactRoadMapNode'
    node:enableNodeEvents()
    return node
end)

local RES_DIR = {
    CORE_ROAD_BG_NUMBER_PRIZE       = _res('ui/home/activity/ArtifactRoad/core_road_bg_number_prize.png'),
    CORE_ROAD_BG_POINT_LOCK         = _res('ui/home/activity/ArtifactRoad/core_road_bg_point_lock.png'),
    CORE_ROAD_BG_POINT_TITLE        = _res('ui/home/activity/ArtifactRoad/core_road_bg_point_title.png'),
    CORE_ROAD_BG_POINT              = _res('ui/home/activity/ArtifactRoad/core_road_bg_point.png'),
    MAPS_BG_ELIMINATE               = _res('ui/home/activity/ArtifactRoad/maps_bg_eliminate.png'),
}

function ArtifactRoadMapNode:ctor( ... )
    local args = unpack({...}) or {}
    self.questId = args.questId
    self.lock = args.lock
    self.isCurrentStage = args.isCurrentStage
    self.star = args.star or 0

    self:InitUI()
end
--[[
init ui
--]]
function ArtifactRoadMapNode:InitUI()
    local stageConf = CommonUtils.GetConfigAllMess('artifactQuest', 'activity')[tostring(self.questId)]

    local function CreateView()
        local plate = display.newImageView(RES_DIR.CORE_ROAD_BG_POINT, VIEW_SIZE.width / 2, 0)
        self:addChild(plate)

        local bg = FilteredSpriteWithOne:create(_res('ui/common/maps_btn_pass_bg.png'))
        bg:setAnchorPoint(cc.p(0.5, 0))
        bg:setPosition(VIEW_SIZE.width / 2, 8)
        self:addChild(bg)
        local size = bg:getContentSize()
        --if self.isCurrentStage then
        --    -- 创建刀叉
        --    local forkSpine = sp.SkeletonAnimation:create('arts/effects/map_fighting_fork.json', 'arts/effects/map_fighting_fork.atlas', 1)
        --    forkSpine:update(0)
        --    forkSpine:addAnimation(0, 'idle', true)
        --    self:addChild(forkSpine, 21)
        --    forkSpine:setPosition(cc.p(VIEW_SIZE.width / 2, size.height + 28))
        --end

        local RewardIcon = FilteredSpriteWithOne:create(CommonUtils.GetGoodsIconPathById(stageConf.rewards[1].goodsId))
        RewardIcon:setAnchorPoint(cc.p(0.5, 0.5))
        RewardIcon:setPosition(VIEW_SIZE.width / 2, 80)
        RewardIcon:setScale(0.5)
        self:addChild(RewardIcon, 2)

        local numBG = display.newImageView(RES_DIR.CORE_ROAD_BG_NUMBER_PRIZE, VIEW_SIZE.width / 2 + 20, RewardIcon:getPositionY() - 23)
        numBG:setAnchorPoint(cc.p(0, 0.5))
        self:addChild(numBG)

        local numLabel = cc.Label:createWithBMFont('font/small/common_text_num.fnt', string.fmt(__('x_num_'), {_num_ = stageConf.rewards[1].num}))
        numLabel:setAnchorPoint(cc.p(0, 0.5))
        numLabel:setPosition(20, utils.getLocalCenter(numBG).y)
        numBG:addChild(numLabel)

        local lockBG = display.newImageView(RES_DIR.MAPS_BG_ELIMINATE, VIEW_SIZE.width / 2, RewardIcon:getPositionY())
        self:addChild(lockBG, 5)
        lockBG:setVisible(false)

        local lockIcon = FilteredSpriteWithOne:create(_res('ui/common/common_ico_lock.png'))
        lockIcon:setPosition(utils.getLocalCenter(lockBG).x, utils.getLocalCenter(lockBG).y + 4)
        lockBG:addChild(lockIcon)

        if self.lock then
            plate:setTexture(RES_DIR.CORE_ROAD_BG_POINT_LOCK)
            bg:setFilter(GrayFilter:create())
            RewardIcon:setFilter(GrayFilter:create())
            lockBG:setVisible(true)
        else
            -- 创建星级
            if QuestRechallenge.QR_CAN == checkint(stageConf.repeatChallenge) then
                for i = 1, self.star do
                    local starIcon = display.newNSprite(_res('ui/map/maps_ico_stars.png'), 0, 0)
                    display.commonUIParams(starIcon, {po = cc.p(
                            VIEW_SIZE.width * 0.5 - 28 + ((starIcon:getContentSize().width * 0.5 + 10) * (i - 0.5 - self.star * 0.5)),
                            (i == (self.star + 1) * 0.5) and size.height + 10 or size.height + 3
                    )})
                    bg:addChild(starIcon)
                end
            else
                -- 打过的不能复刷的关卡创建标识
                local clearMarkBg = display.newImageView(_res('ui/map/maps_bg_eliminate.png'), VIEW_SIZE.width * 0.5, size.height * 0.5 + 8)
                bg:addChild(clearMarkBg, 21)
                local clearMarkLabel = display.newLabel(utils.getLocalCenter(clearMarkBg).x, utils.getLocalCenter(clearMarkBg).y,
                        {text = __('已消灭'), fontSize = fontWithColor('18').fontSize, color = fontWithColor('18').color})
                clearMarkBg:addChild(clearMarkLabel)
            end
        end
        -- 关卡序号
        local stageNoBg = display.newNSprite(RES_DIR.CORE_ROAD_BG_POINT_TITLE, VIEW_SIZE.width / 2, -26)
        self:addChild(stageNoBg, 20)

        local stageNoLabel = display.newLabel(utils.getLocalCenter(stageNoBg).x, utils.getLocalCenter(stageNoBg).y,
                fontWithColor(18,{text = stageConf.name }))
        stageNoBg:addChild(stageNoLabel)

        return {
            bg          = bg,
            view        = view,
        }
    end
    xTry(function ( )
        self.viewData = CreateView()

        self:setTouchEnabled(true)
        self:setOnClickScriptHandler(function (sender)
            AppFacade.GetInstance():DispatchObservers(ARTIFACT_ROAD_MAP_STAGE_CLICK_EVENT, {questId = self.questId, star = self.star})
        end)

    end, __G__TRACKBACK__)
end

return ArtifactRoadMapNode