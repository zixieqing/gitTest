---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xingweihao.
--- DateTime: 2018/10/12 3:27 PM
---
local GameScene = require( 'Frame.GameScene' )
---@class AnniversaryMainLineMapView
local AnniversaryMainLineMapView = class('AnniversaryMainLineMapView', GameScene)
local newImageView = display.newImageView
local newLabel = display.newLabel
local newNSprite = display.newNSprite
local newButton = display.newButton
local newLayer = display.newLayer
local RES_DICT = {
    ANNI_MAPS_TWO_BTN_BG          = app.anniversaryMgr:GetResPath('ui/anniversary/map/anni_maps_two_btn_bg.png'),
    ANNI_MAPS_TWO_BTN_SHIP        = app.anniversaryMgr:GetResPath('ui/anniversary/map/anni_maps_two_btn_ship.png'),
    ANNI_MAPS_TWO_BTN_DICE        = app.anniversaryMgr:GetResPath('ui/anniversary/map/anni_maps_two_btn_dice.png'),
    ANNI_MAPS_TWO_1               = app.anniversaryMgr:GetResPath('ui/anniversary/map/anni_maps_level2_1.jpg'),
    ANNI_MAPS_TWO_BG_SHIP         = app.anniversaryMgr:GetResPath('ui/anniversary/map/anni_maps_two_bg_ship.png'),
    ANNI_MAPS_TWO_BTN_BG_JUDGE    = app.anniversaryMgr:GetResPath('ui/anniversary/map/anni_maps_two_btn_bg_judge.png'),
    ANNI_MAPS_TWO_NAME_BG         = app.anniversaryMgr:GetResPath('ui/anniversary/map/anni_maps_two_name_bg.png'),
    COMMON_BTN_WHITE_DEFAULT      = app.anniversaryMgr:GetResPath('ui/common/common_btn_white_default.png'),
    ANNI_MAPS_TWO_SHIP_FRAME_TOP  = app.anniversaryMgr:GetResPath('ui/anniversary/map/anni_maps_two_ship_frame_top.png'),
    ANNI_MAPS_TWO_BTN_NAME        = app.anniversaryMgr:GetResPath('ui/anniversary/map/anni_maps_two_btn_name.png'),
    ANNI_MAPS_TWO_SHIP_FRAME_DOWN = app.anniversaryMgr:GetResPath('ui/anniversary/map/anni_maps_two_ship_frame_down.png'),
    ANNI_MAPS_LEVEL2_2_SPOT_UP    = app.anniversaryMgr:GetResPath('ui/anniversary/map/anni_maps_level2_2_spot_up.png'),
    ANNI_QBAN_SHADOW              = app.anniversaryMgr:GetResPath('ui/anniversary/map/anni_qban_shadow.png'),
    COMMON_BTN_ORANGE             = app.anniversaryMgr:GetResPath('ui/common/common_btn_orange.png'),
    COMMON_BTN_BACK               = app.anniversaryMgr:GetResPath('ui/common/common_btn_back.png'),
    COMMON_BG_TIPS_S               = app.anniversaryMgr:GetResPath('ui/common/maps_boss_name.png'),
}

function AnniversaryMainLineMapView:ctor( param  )
    param = param or {}
    local mapId = param.mapId or 1
    print("mapId = " , mapId)
    local view = newLayer(display.cx, display.cy,{ap = display.CENTER, size = display.size})
    display.loadImage(AssetsUtils.GetCardDrawPath(app.anniversaryMgr:GetResPath(string.format('ui/anniversary/map/anni_maps_level2_%d.jpg' , mapId))) , function()
        local bgImage = newNSprite(app.anniversaryMgr:GetResPath(string.format('ui/anniversary/map/anni_maps_level2_%d.jpg' , mapId)), display.cx, display.cy ,
                                   { ap = display.CENTER, tag = 143 })
        bgImage:setScale(1, 1)
        view:addChild(bgImage,-1)
    end)
    self:addChild(view)

    local swallowLayer = display.newLayer(display.cx , display.cy , {ap = display.CENTER , size = display.size , color = cc.c4b(0,0,0,0) , enable = true })
    view:addChild(swallowLayer)

    local backBtn = display.newImageView(RES_DICT.COMMON_BTN_BACK, 57, 695,
                                         { ap = display.CENTER, tag = 68 ,enable = true  } )
    backBtn:setScale(1, 1)
    backBtn:setPosition(display.SAFE_L + 57, display.height - 55)
    self:addChild(backBtn , 2 )

    local  moveLayer = display.newLayer(display.cx , display.cy , {ap = display.CENTER, size = display.size})
    self:addChild(moveLayer,1 )

    local leftBottomLayout = newLayer(0, 0,
                                      { ap = display.LEFT_BOTTOM, size = cc.size(400, 200) })
    leftBottomLayout:setPosition(display.SAFE_L + 0, 0)
    view:addChild(leftBottomLayout)
    --local richLabel = display.newRichLabel(140 , 160 , { r = true ,  c = {
    --    fontWithColor(10 ,{text = ""})
    --}} )
    --leftBottomLayout:addChild(richLabel)
    local consumBg = display.newButton( 125 , 90 ,{ n = RES_DICT.COMMON_BG_TIPS_S , scale9 = true , enable =false} )
    leftBottomLayout:addChild(consumBg,3)
    local bottomBtn = newImageView(RES_DICT.ANNI_MAPS_TWO_BTN_BG, 87, 22,
                                   { ap = display.CENTER, tag = 134, enable = false })
    leftBottomLayout:addChild(bottomBtn)

    local shipBtn = newButton(123, 88, { ap = display.CENTER ,  n = RES_DICT.ANNI_MAPS_TWO_BTN_SHIP, s = RES_DICT.ANNI_MAPS_TWO_BTN_SHIP})
    display.commonLabelParams(shipBtn, {text = "", fontSize = 14, color = '#414146'})
    leftBottomLayout:addChild(shipBtn)

    local nameBg = newButton(123, 30, { ap = display.CENTER ,  n = RES_DICT.ANNI_MAPS_TWO_BTN_NAME, s = RES_DICT.ANNI_MAPS_TWO_BTN_NAME , scale9 = true })
    display.commonLabelParams(nameBg, fontWithColor(14, { text = app.anniversaryMgr:GetPoText(__('环游飞艇')), fontSize = 26, color = '#ffffff'  , paddingW = 10}))
    leftBottomLayout:addChild(nameBg)

    local rightBottomLayout = newLayer(1333, 0,
                                       { ap = display.RIGHT_BOTTOM, size = cc.size(400, 200) })
    rightBottomLayout:setPosition(display.SAFE_R + -1, 0)
    view:addChild(rightBottomLayout)

    local twoBtns = newImageView(RES_DICT.ANNI_MAPS_TWO_BTN_BG, 314, 20,
                                 { ap = display.CENTER, tag = 137, enable = false })
    rightBottomLayout:addChild(twoBtns)
    twoBtns:setScaleX(-1)

    local diceBtn = newButton(278, 88, { ap = display.CENTER ,  n = RES_DICT.ANNI_MAPS_TWO_BTN_DICE, s = RES_DICT.ANNI_MAPS_TWO_BTN_DICE})
    display.commonLabelParams(diceBtn, {text = "", fontSize = 14, color = '#414146'})
    rightBottomLayout:addChild(diceBtn)

    local nameBg = newButton(54, -6, { ap = display.CENTER ,  n = RES_DICT.ANNI_MAPS_TWO_BTN_NAME, s = RES_DICT.ANNI_MAPS_TWO_BTN_NAME})
    display.commonLabelParams(nameBg, fontWithColor(14, { text = app.anniversaryMgr:GetPoText(__('行动')), fontSize = 26, color = '#ffffff' }))
    diceBtn:addChild(nameBg)

    local giveUpBtn = newButton(1260, 703, { ap = display.CENTER ,  n = RES_DICT.COMMON_BTN_ORANGE, d = RES_DICT.COMMON_BTN_ORANGE, s = RES_DICT.COMMON_BTN_ORANGE})
    display.commonLabelParams(giveUpBtn, fontWithColor(14, { text =  app.anniversaryMgr:GetPoText(__('放弃')), fontSize = 24, color = '#ffffff' }))
    giveUpBtn:setPosition(display.SAFE_R -74, display.height  -47)
    self:addChild(giveUpBtn ,10)

    local spineLayer = display.newLayer(display.cx , display.cy , {ap = display.CENTER , size = display.size , color = cc.c4b(0,0,0,175) })
    self:addChild(spineLayer ,10001 )
    spineLayer:setVisible(false)

    local lightLayer = display.newLayer(display.cx , display.cy , {ap = display.CENTER})
    self:addChild(lightLayer , 99)
    local  qAvatarImage = display.newImageView(RES_DICT.ANNI_QBAN_SHADOW,display.cx ,display.cy )
    self:addChild(qAvatarImage ,2)
    qAvatarImage:setVisible(false)
    self.viewData =  {
        leftBottomLayout        = leftBottomLayout,
        bottomBtn               = bottomBtn,
        shipBtn                 = shipBtn,
        rightBottomLayout       = rightBottomLayout,
        twoBtns                 = twoBtns,
        diceBtn                 = diceBtn,
        nameBg                  = nameBg,
        giveUpBtn               = giveUpBtn,
        view                    = view,
        backBtn                 = backBtn ,
        moveLayer               = moveLayer ,
        consumBg               = consumBg ,
        spineLayer              = spineLayer,
        qAvatarImage            = qAvatarImage ,
        lightLayer              = lightLayer,
    }
end

function AnniversaryMainLineMapView:CreateAnimationLayout()

    local animationLayout = newLayer(display.cx, display.cy ,
                                     { ap = display.CENTER, size = cc.size(display.width, display.height)})
    self:addChild(animationLayout,2)
    animationLayout:setName("animationLayout")
    animationLayout:setVisible(false)
    local shipBgImage = newImageView(RES_DICT.ANNI_MAPS_TWO_BG_SHIP, 667, 375,
                                     { ap = display.CENTER, tag = 154, enable = true  })
    shipBgImage:setPosition(display.cx + 0, display.cy + 0)
    animationLayout:addChild(shipBgImage)

    local bottomLayout = newLayer(667, 0,
                                  { ap = display.CENTER_BOTTOM, size = cc.size(1335, 200) })
    bottomLayout:setPosition(display.cx + 0, 0)
    animationLayout:addChild(bottomLayout)

    local shipDownIMage = newNSprite(RES_DICT.ANNI_MAPS_TWO_SHIP_FRAME_DOWN, 667, 0,
                                     { ap = display.CENTER_BOTTOM, tag = 147 })
    shipDownIMage:setScale(1, 1)
    bottomLayout:addChild(shipDownIMage)

    local judageLayout = newLayer(665, 0,
                                  { ap = display.CENTER_TOP,  size = cc.size(346, 104) })
    bottomLayout:addChild(judageLayout)
    judageLayout:setVisible(false)
    local judageImage = newImageView(RES_DICT.ANNI_MAPS_TWO_BTN_BG_JUDGE, 173, 52,
                                     { ap = display.CENTER, tag = 150, enable = false })
    judageLayout:addChild(judageImage)

    local cancelBtn = newButton(86, 52, { ap = display.CENTER ,  n = RES_DICT.COMMON_BTN_WHITE_DEFAULT, d = RES_DICT.COMMON_BTN_WHITE_DEFAULT, s = RES_DICT.COMMON_BTN_WHITE_DEFAULT, tag = 151 })
    display.commonLabelParams(cancelBtn, fontWithColor(14,{text = app.anniversaryMgr:GetPoText(__('取消')), fontSize = 24, color = '#ffffff'}))
    judageLayout:addChild(cancelBtn)

    local travelBtn = newButton(265, 52, { ap = display.CENTER ,  n = RES_DICT.COMMON_BTN_ORANGE, d = RES_DICT.COMMON_BTN_ORANGE, s = RES_DICT.COMMON_BTN_ORANGE, tag = 152 })
    display.commonLabelParams(travelBtn, fontWithColor(14,{text = app.anniversaryMgr:GetPoText(__('前 往')), fontSize = 24, color = '#ffffff'}))
    judageLayout:addChild(travelBtn)

    local topLayout = newLayer(display.cx , display.cy ,
                               { ap = display.CENTER_TOP, size = cc.size(1335, 200), enable = true })
    topLayout:setPosition(display.cx + 0, display.height + 0)
    animationLayout:addChild(topLayout)


    local shipTop = newNSprite(RES_DICT.ANNI_MAPS_TWO_SHIP_FRAME_TOP, 667, 200,
                               { ap = display.CENTER_TOP, tag = 145 })
    shipTop:setScale(1, 1)
    topLayout:addChild(shipTop)

    local descrLabel = newLabel(667, 153,
                                fontWithColor('14', { ap = display.CENTER, outline = false, ttf = true, font = TTF_GAME_FONT, color = '#5b3c25', fontSize = 30, text =app.anniversaryMgr:GetPoText(__('请点击你的目的地')), tag = 146 }))
    topLayout:addChild(descrLabel)

    local backBtn = display.newImageView(RES_DICT.COMMON_BTN_BACK, 57, 695,
                                         { ap = display.CENTER, tag = 68 ,enable = true } )
    backBtn:setPosition(display.SAFE_L + 57, display.height - 55)
    animationLayout:addChild(backBtn , 1 )
    animationLayout.viewData = {
        animationLayout         = animationLayout,
        shipBgImage             = shipBgImage,
        bottomLayout            = bottomLayout,
        shipDownIMage           = shipDownIMage,
        judageLayout            = judageLayout,
        judageImage             = judageImage,
        cancelBtn               = cancelBtn,
        travelBtn               = travelBtn,
        topLayout               = topLayout,
        shipTop                 = shipTop,
        descrLabel              = descrLabel,
        backBtn                 = backBtn ,

    }
    return  animationLayout
end
function AnniversaryMainLineMapView:AddSpotUpImage()
    local image = display.newImageView(RES_DICT.ANNI_MAPS_LEVEL2_2_SPOT_UP , display.cx + 25  , display.cy - 50  )
    self.viewData.moveLayer:addChild(image,2)
end

function AnniversaryMainLineMapView:CreateCardSpin(cardData)
    local qAvatar = AssetsUtils.GetCardSpineNode({skinId = cardData.defaultSkinId, scale = 0.7})
    qAvatar:update(0)
    qAvatar:setTag(1)
    qAvatar:setAnimation(0, 'run', true)
    qAvatar:setScale(0.8)
    qAvatar:setName("qAvatar")
    qAvatar:setName("qAvatar")
    return qAvatar
end
function AnniversaryMainLineMapView:EnterCreateAnimationLayoutAction()
    local animationLayout = self:getChildByName("animationLayout")
    local viewData =  animationLayout.viewData
    local topLayout =viewData.topLayout
    local shipBgImage =viewData.shipBgImage
    shipBgImage:setOpacity(0)
    local topLayoutPos = cc.p(topLayout:getPosition())
    topLayout:setOpacity(0)
    topLayout:setPosition(cc.p(topLayoutPos.x , topLayoutPos.y +400))
    local bottomLayout = viewData.bottomLayout
    bottomLayout:setOpacity(0)
    local bottomLayoutPos = cc.p(bottomLayout:getPosition())
    bottomLayout:setPosition(bottomLayoutPos.x , bottomLayoutPos.y - 200 )
    local nNUm  = 0.5
    bottomLayout:runAction(cc.Spawn:create(
        cc.Sequence:create(
            cc.Spawn:create(
                cc.TargetedAction:create(shipBgImage ,
                    cc.Sequence:create(
                        cc.FadeIn:create(0.2*nNUm) ,cc.DelayTime:create(0.8)
                    )
                ),
                cc.TargetedAction:create(
                    topLayout , cc.Spawn:create(
                        cc.FadeIn:create(1*nNUm),
                        cc.JumpTo:create(1*nNUm , topLayoutPos , -70, 2)
                    )
                ),
                cc.FadeIn:create(1*nNUm),
                cc.Sequence:create(
                    cc.MoveTo:create(  1*nNUm , bottomLayoutPos )
                )
            )
        )

    ))
end

function AnniversaryMainLineMapView:CreateChapterRewardLayer(chapterId)
    local outline = display.newImageView(app.anniversaryMgr:GetResPath('ui/common/common_bg_8.png'), 0,0,{
        enable = true , scale9 = true ,  size =  cc.size(420, 300 ) , capInsets = cc.rect(50,50,1,1)
    })
    local layer = display.newLayer(display.cx , display.cy , {ap = display.CENTER  })
    local swallowLayer = display.newLayer(display.cx , display.cy , {ap = display.CENTER  , color = cc.c4b(0,0,0,175) ,enable = true , cb = function()
        layer:runAction(cc.RemoveSelf:create())
    end })
    layer:addChild(swallowLayer)

    self:addChild(layer,10000)
    layer:setPosition(display.center)
    local tipSize =    cc.size(400 , 330 )
    local tipView = display.newLayer(display.cx , display.cy , {ap = display.CENTER , size = tipSize  })
    layer:addChild(tipView)
    outline:setPosition(tipSize.width/2, tipSize.height/2 )
    tipView:addChild(outline)

    local label = display.newLabel(tipSize.width /2  , tipSize.height -60   , fontWithColor(8,{ap = display.CENTER_TOP , text = app.anniversaryMgr:GetPoText(__('通关后获得超丰富奖励'))  , w = 300 , hAlign= display.TAC}))
    tipView:addChild(label,10)
    local anniversaryManager = app.anniversaryMgr
    local parserConfig = anniversaryManager:GetConfigParse()
    local chapterConfig =  anniversaryManager:GetConfigDataByName(parserConfig.TYPE.CHAPTER)
    local chapterData = chapterConfig[tostring(chapterId)] or {}
    local rewards = chapterData.rewards or {}
    local view  = tipView
    local commonTipSize = tipSize
    local goodSize = cc.size(360 , 184)
    local goodLayout = display.newLayer(commonTipSize.width/2 , commonTipSize.height - 100 , {ap = display.CENTER_TOP , size =  goodSize  })
    view:addChild(goodLayout,10)
    rewards = clone(rewards)
    local data = {num = checkint(chapterData.score) , goodsId = app.anniversaryMgr:GetAnniversaryScoreId()}
    rewards[#rewards+1] = data
    local count =  #rewards
    if count <= 4  then
        for i = 1, count do
            rewards[i].showAmount = true
            local goodNode = require('common.GoodNode').new(rewards[i])
            display.commonUIParams(goodNode, {animate = false,  cb = function(sender)
                app.uiMgr:ShowInformationTipsBoard({targetNode = sender, iconId = rewards[i].goodsId, type = 1})
            end})
            goodNode:setPosition(goodSize.width /count * (i - 0.5 ) , goodSize.height/2)
            goodLayout:addChild(goodNode)
            goodNode:setScale(0.7)
        end
    else
        local goodNodeWidth =  goodSize.width/4
        local goodNodeHeight =  goodSize.height/2
        for i = 1, count do
            rewards[i].showAmount = true
            local goodNode = require('common.GoodNode').new(rewards[i])
            local  index = i - 0.5
            local  lineY =   math.floor(index / 4)
            local  lineX =index % 4
            display.commonUIParams(goodNode, {animate = false,  cb = function(sender)
                app.uiMgr:ShowInformationTipsBoard({targetNode = sender, iconId = rewards[i].goodsId, type = 1})
            end})
            goodNode:setPosition(goodNodeWidth  * lineX  , goodNodeHeight  * (2 -  (lineY +  0.5) )  )
            goodNode:setScale(0.7)
            goodLayout:addChild(goodNode)
        end
    end
end
function AnniversaryMainLineMapView:MoveOutAnimationLayoutAction(callback)
    local arrowImage  = self:getChildByName("arrowImage")
    if arrowImage then
        arrowImage:setVisible(false)
    end
    local animationLayout = self:getChildByName("animationLayout")
    animationLayout:runAction(
        cc.Sequence:create(
            cc.FadeOut:create(0.2) ,
            cc.CallFunc:create(function()
                if callback then
                    callback()
                end
            end),
            cc.RemoveSelf:create()
        )
    )
end

return AnniversaryMainLineMapView
