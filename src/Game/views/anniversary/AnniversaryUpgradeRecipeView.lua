---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xingweihao.
--- DateTime: 2018/10/12 3:27 PM
---
---@class AnniversaryUpgradeRecipeView
local AnniversaryUpgradeRecipeView = class('AnniversaryUpgradeRecipeView', function ()
    local node = CLayout:create(display.size)
    node.name = 'Game.views.artifact.AnniversaryUpgradeRecipeView'
    node:setName('AnniversaryUpgradeRecipeView')
    node:enableNodeEvents()
    return node
end)

local newImageView = display.newImageView
local newLabel = display.newLabel
local newNSprite = display.newNSprite
local newButton = display.newButton
local newLayer = display.newLayer
local anniversaryManager = app.anniversaryMgr
local RES_DICT = {
    COMMON_BTN_ORANGE                    = app.anniversaryMgr:GetResPath('ui/common/common_btn_orange.png'),
    SUMMER_ACTIVITY_EGG_EXTRA_BAR_GREY   = app.anniversaryMgr:GetResPath('ui/home/activity/summerActivity/carnie/summer_activity_egg_extra_bar_grey.png'),
    ROLE_13                              = app.anniversaryMgr:GetResPath('arts/roles/role_13.png'),
    COMMON_REWARD_LIGHT                  = app.anniversaryMgr:GetResPath('ui/common/common_reward_light.png'),
    GOODS_ICON_121001                    = app.anniversaryMgr:GetResPath('arts/goods/goods_icon_121001.png'),
    SUMMER_ACTIVITY_EGG_EXTRA_BAR_ACTIVE = app.anniversaryMgr:GetResPath('ui/home/activity/summerActivity/carnie/summer_activity_egg_extra_bar_active.png'),
    COMMON_WORDS_LEVELUP                 = app.anniversaryMgr:GetResPath('ui/common/common_words_levelup.png'),
    COMMON_WORDS_CONGRATULATIONS                 = app.anniversaryMgr:GetResPath('ui/common/common_words_congratulations.png'),
    COOKING_GRADE_ICO_4                  = app.anniversaryMgr:GetResPath('ui/home/kitchen/cooking_grade_ico_4.png'),
    KITCHEN_FOODS_NAME_DELICATE          = app.anniversaryMgr:GetResPath('ui/home/kitchen/kitchen_foods_name_delicate.png'),
    COOKING_LEVEL_UP_ICO_ARROW           = app.anniversaryMgr:GetResPath('ui/home/kitchen/cooking_level_up_ico_arrow.png'),
    COOKING_GRADE_ICO_5                  = app.anniversaryMgr:GetResPath('ui/home/kitchen/cooking_grade_ico_5.png'),
}
function AnniversaryUpgradeRecipeView:ctor(param)
    local param = param or {}
    local shopId = param.shopId
    self.shopId = shopId
    self:InitUi()
    self:UpdateUI()
end
function AnniversaryUpgradeRecipeView:InitUi()
    local view = newLayer(display.cx, display.cy,{ap = display.CENTER, size = display.size})
    self:addChild(view)
    local closeLayer = newLayer(display.cx , display.cy ,
                                { ap = display.CENTER, color = cc.c4b(0,0,0,175), size = cc.size(display.width, display.height), enable = true  })
    view:addChild(closeLayer)

    local roleImage = newNSprite(RES_DICT.ROLE_13, 350, -71,
                                 { ap = display.CENTER, tag = 231 })
    roleImage:setScale(1, 1)
    roleImage:setPosition(display.cx + -317, display.cy + -446)
    view:addChild(roleImage)
    roleImage:setOpacity(0)

    local rightLayout = newLayer(993, 356,
                                 { ap = display.CENTER, size = cc.size(500, 650) })
    view:addChild(rightLayout)
    rightLayout:setPosition(display.cx + 326, display.cy + -19)

    local swallowLayer = newLayer(0, 0,
                                  { ap = display.LEFT_BOTTOM, color = cc.r4b(0), size = cc.size(500, 650), enable = true })
    rightLayout:addChild(swallowLayer)

    local lightImage = newNSprite(RES_DICT.COMMON_REWARD_LIGHT, 237, 411,
                                  { ap = display.CENTER, tag = 243 })
    lightImage:setScale(1, 1)
    rightLayout:addChild(lightImage)

    local levelUpImage = newNSprite(RES_DICT.COMMON_WORDS_LEVELUP, 237, 572,
                                    { ap = display.CENTER, tag = 244 })
    levelUpImage:setScale(1, 1)
    rightLayout:addChild(levelUpImage)

    local recipeImage = newNSprite(RES_DICT.GOODS_ICON_121001, 237, 416,
                                   { ap = display.CENTER, tag = 245 })
    recipeImage:setScale(1, 1)
    rightLayout:addChild(recipeImage)

    local makeSureBtn = newButton(233, 33, { ap = display.CENTER ,  n = RES_DICT.COMMON_BTN_ORANGE, d = RES_DICT.COMMON_BTN_ORANGE, s = RES_DICT.COMMON_BTN_ORANGE, scale9 = true, size = cc.size(123, 62), tag = 246 , cb = function()
       self:stopAllActions()
       self:removeFromParent()
    end })
    display.commonLabelParams(makeSureBtn, fontWithColor(14, { text = app.anniversaryMgr:GetPoText(__('确定')), fontSize = 24, color = '#ffffff' }))
    rightLayout:addChild(makeSureBtn)

    local recipeLevelImage = newImageView(RES_DICT.COOKING_GRADE_ICO_5, 103, 193,
                                          { ap = display.CENTER, tag = 236, enable = false })
    rightLayout:addChild(recipeLevelImage)

    local prograsssBgImage = newImageView(RES_DICT.SUMMER_ACTIVITY_EGG_EXTRA_BAR_GREY, 241, 193,
                                          { ap = display.CENTER, tag = 239, enable = false })
    rightLayout:addChild(prograsssBgImage)

    local prograss = CProgressBar:create(RES_DICT.SUMMER_ACTIVITY_EGG_EXTRA_BAR_ACTIVE)
    prograss:setAnchorPoint(cc.p(0.5, 0.5))
    prograss:setMaxValue(100)
    prograss:setValue(0)
    prograss:setScale(1, 1)
    prograss:setPosition(241,193)
    prograss:setDirection(eProgressBarDirectionLeftToRight)
    rightLayout:addChild(prograss)
    rightLayout:setOpacity(0)
    local expValueLabel = newLabel(227, 151,
                                   { ap = display.CENTER, color = '#ffb400', text = "", fontSize = 24, tag = 240 })
    rightLayout:addChild(expValueLabel)

    local recipeName = newButton(232, 273, { ap = display.CENTER ,  n = RES_DICT.KITCHEN_FOODS_NAME_DELICATE, d = RES_DICT.KITCHEN_FOODS_NAME_DELICATE, s = RES_DICT.KITCHEN_FOODS_NAME_DELICATE, scale9 = true, size = cc.size(265, 40), tag = 241 })
    display.commonLabelParams(recipeName, fontWithColor(14, { text = 'xxx', fontSize = 24, color = '#ffffff' }))
    rightLayout:addChild(recipeName)

    local upadeLayout = newLayer(67, 196,
                                 { ap = display.CENTER, size = cc.size(200, 50) })
    rightLayout:addChild(upadeLayout)

    local currentLevel = newImageView(RES_DICT.COOKING_GRADE_ICO_4, 52, 22,
                                      { ap = display.CENTER, tag = 259, enable = false })
    upadeLayout:addChild(currentLevel)

    local nextLevel = newImageView(RES_DICT.COOKING_GRADE_ICO_5, 135, 22,
                                   { ap = display.CENTER, tag = 260, enable = false })
    upadeLayout:addChild(nextLevel)

    local oneImage = newImageView(RES_DICT.COOKING_LEVEL_UP_ICO_ARROW, 84, 19,
                                  { ap = display.CENTER, tag = 261, enable = false })
    upadeLayout:addChild(oneImage)

    local twoImage = newImageView(RES_DICT.COOKING_LEVEL_UP_ICO_ARROW, 94, 19,
                                  { ap = display.CENTER, tag = 262, enable = false })
    upadeLayout:addChild(twoImage)

    local threeImage = newImageView(RES_DICT.COOKING_LEVEL_UP_ICO_ARROW, 104, 19,
                                    { ap = display.CENTER, tag = 263, enable = false })
    upadeLayout:addChild(threeImage)
    self.viewData =  {
        closeLayer              = closeLayer,
        roleImage               = roleImage,
        rightLayout             = rightLayout,
        swallowLayer            = swallowLayer,
        lightImage              = lightImage,
        levelUpImage            = levelUpImage,
        recipeImage             = recipeImage,
        makeSureBtn             = makeSureBtn,
        recipeLevelImage        = recipeLevelImage,
        prograsssBgImage        = prograsssBgImage,
        prograss                = prograss,
        expValueLabel           = expValueLabel,
        recipeName              = recipeName,
        upadeLayout             = upadeLayout,
        currentLevel            = currentLevel,
        nextLevel               = nextLevel,
        oneImage                = oneImage,
        twoImage                = twoImage,
        threeImage              = threeImage,
    }
end
function AnniversaryUpgradeRecipeView:UpdateUI()
    local shopId = self.shopId
    local parserConfig = anniversaryManager:GetConfigParse()
    local blackRecipeMarketConfig = anniversaryManager:GetConfigDataByName(parserConfig.TYPE.BLACK_RECIPE_MARKET)
    local blackRecipeMarketData = blackRecipeMarketConfig[tostring(shopId)] or {}
    local addExpValue = checkint(blackRecipeMarketData.exp)
    local recipes = anniversaryManager.homeData.recipes or {}
    local expValue  = checkint(recipes[tostring(blackRecipeMarketData.foodId)])
    local lastExp =    expValue -  addExpValue
    local lastLevel = anniversaryManager:GetRecipeLevelByExp(lastExp)
    local currentLevel = anniversaryManager:GetRecipeLevelByExp(expValue)
    local viewData = self.viewData
    local recipeLevelConfig =  anniversaryManager:GetConfigDataByName(parserConfig.TYPE.FOOD_LEVEL)
    local level = currentLevel >=  table.nums(recipeLevelConfig) and currentLevel or  (currentLevel+1)
    local maxValue  = checkint(recipeLevelConfig[tostring(level)].exp)
    local recipeConfig = anniversaryManager:GetConfigDataByName(parserConfig.TYPE.FOOD_ATTR)
    local exp = expValue >= maxValue and maxValue or expValue

    local rewardPoint_Srtart =  cc.p(237 ,  display.height+94.6)
    local rewardPoint_one = cc.p(237 ,  display.cy+300-35.5-50)
    local rewardPoint_Two = cc.p(237 ,  display.cy+300+24-50)
    local rewardPoint_Three = cc.p(237 ,  display.cy+300-15-50)
    local rewardPoint_Four = cc.p(237,  display.cy+300-15 -50 )
    local rewardSequnece = cc.Sequence:create(    -- 获取队列的动画展示
            cc.DelayTime:create(0.4) ,cc.CallFunc:create(function ( )
                self.viewData.levelUpImage:setVisible(true)
                self.viewData.levelUpImage:setOpacity(0)
                self.viewData.levelUpImage:setPosition(rewardPoint_Srtart)
            end),
            cc.Spawn:create(cc.FadeIn:create(0.2),cc.MoveTo:create(0.2,rewardPoint_one)),
            cc.MoveTo:create(0.1,rewardPoint_Two) ,
            cc.MoveTo:create(0.1,rewardPoint_Three) ,
            cc.MoveTo:create(0.1,rewardPoint_Four)
    )
    self.viewData.levelUpImage:runAction(rewardSequnece)
    local recipeImageAction = cc.Sequence:create(
            cc.DelayTime:create(0.2),
            cc.CallFunc:create(function ()
                self.viewData.recipeImage:setScale(0.14)
                self.viewData.recipeImage:setVisible(true)
            end ) ,
            cc.ScaleTo:create(0.2 ,  1.5) , cc.ScaleTo:create(0.1,0.6)
    )
    self.viewData.recipeImage:runAction(recipeImageAction) --菜谱UI动画展示

    local ligthAction = cc.Sequence:create(    -- 光的动画展示
            cc.DelayTime:create(0.1) ,
            cc.CallFunc:create( function ()
                self.viewData.lightImage:setVisible(true)
                self.viewData.lightImage:setScale(0.519)
                self.viewData.lightImage:setRotation(-0.8)
            end) ,
            cc.Spawn:create(cc.ScaleTo:create(0.1, 0.96) ,cc.RotateTo:create(0.1, 10)) ,
            cc.Spawn:create(cc.ScaleTo:create(1.8, 1) ,cc.RotateTo:create(1.8, 78)) ,
            cc.RotateTo:create(4.9 *1000, 180*1000)
    )
    self.viewData.lightImage:runAction(ligthAction)
    local rightLayout = self.viewData.rightLayout
    rightLayout:runAction(
            cc.Spawn:create(
                    cc.Sequence:create(cc.DelayTime:create(0.5) ,cc.FadeIn:create(0.5))  ,
                    cc.TargetedAction:create(self.viewData.roleImage , cc.Sequence:create(
                            cc.FadeIn:create(1) , cc.DelayTime:create(0.5)
                    )   )
            )

    )
    if currentLevel ==  lastLevel then
        viewData.levelUpImage:setVisible(false)
        viewData.upadeLayout:setVisible(false)
        viewData.recipeLevelImage:setVisible(true)
        viewData.recipeLevelImage:setTexture(app.anniversaryMgr:GetResPath( string.format('ui/home/kitchen/cooking_grade_ico_%d.png' , lastLevel) ))
        viewData.levelUpImage:setTexture(RES_DICT.COMMON_WORDS_CONGRATULATIONS)
    else
        local iconUpTable = { self.viewData.oneImage ,self.viewData.twoImage ,self.viewData.threeImage  }
        for i = 1 ,#iconUpTable do
            local icon_Up = iconUpTable[i]
            icon_Up:setOpacity(0)
            icon_Up:runAction(cc.Sequence:create(
                cc.DelayTime:create(0.5*i ) , cc.CallFunc:create(
                    function ()
                        icon_Up:stopAllActions()
                        icon_Up:runAction(cc.RepeatForever:create(
                                cc.Sequence:create(cc.FadeIn:create(1.5),cc.FadeOut:create(1.5))
                        )
                        )
                    end
                )
            ))
        end
        viewData.levelUpImage:setVisible(true)
        viewData.upadeLayout:setVisible(true)
        viewData.recipeLevelImage:setVisible(false)
        viewData.nextLevel:setTexture(app.anniversaryMgr:GetResPath( string.format('ui/home/kitchen/cooking_grade_ico_%d.png' , currentLevel) ))
        viewData.currentLevel:setTexture(app.anniversaryMgr:GetResPath( string.format('ui/home/kitchen/cooking_grade_ico_%d.png' , lastLevel) ))
    end
    display.commonLabelParams(viewData.expValueLabel , { text =  string.format(app.anniversaryMgr:GetPoText(__('熟练度：%d + %d')) , lastExp , addExpValue)})
    viewData.prograss:setMaxValue(maxValue)
    viewData.prograss:setValue(exp)
    viewData.recipeImage:setTexture(anniversaryManager:GetAnniversaryRecipePathByRecipId(blackRecipeMarketData.foodId, true ))
    local recipeOneConfig = recipeConfig[tostring(blackRecipeMarketData.foodId)]
    local name = recipeOneConfig.name
    display.commonLabelParams(viewData.recipeName , {text = name })
end
return AnniversaryUpgradeRecipeView
